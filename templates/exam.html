{% extends "base.html" %}

{% block title %}{{ exam.title }} · SmartQuiz{% endblock %}

{% block content %}
  <div class="mb-6">
    <a href="/" class="text-sm text-muted-foreground hover:text-foreground">&larr; Back to exams</a>
  </div>

  <div class="mb-8">
    <h1 class="text-2xl font-semibold tracking-tight">{{ exam.title }}</h1>
    <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
      {% if exam.description %}
        <p>{{ exam.description }}</p>
      {% endif %}
      {% if exam.difficulty %}
        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium
                     {% if exam.difficulty == 'easy' %}
                       bg-emerald-500/10 text-emerald-400 border border-emerald-500/30
                     {% elif exam.difficulty == 'hard' %}
                       bg-rose-500/10 text-rose-400 border border-rose-500/30
                     {% else %}
                       bg-amber-500/10 text-amber-400 border border-amber-500/30
                     {% endif %}">
          {{ exam.difficulty|capitalize }}
        </span>
      {% endif %}
      <span class="text-xs uppercase tracking-wide text-muted-foreground">
        {{ exam.questions|length }} questions
      </span>
      {% if exam.time_limit_seconds %}
        {% set hours = (exam.time_limit_seconds // 3600) %}
        {% set mins = ((exam.time_limit_seconds % 3600) // 60) %}
        <span class="text-xs uppercase tracking-wide text-muted-foreground font-mono">
          ⏱️ {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
        </span>
      {% endif %}
      <span class="text-xs uppercase tracking-wide text-muted-foreground font-mono">
        Mode: {{ exam.format|default("multiple") }}
      </span>
    </div>

    {% if exam.time_limit_seconds %}
      <div id="timer" class="text-3xl font-mono font-bold text-sky-500 mt-6 mb-6 p-4 bg-muted/50 rounded-xl border border-sky-500/30 text-center animate-pulse" data-max-time="{{ exam.time_limit_seconds }}"></div>
    {% endif %}
  </div>

  <form method="post" class="space-y-4" id="examForm" data-format="{{ exam.format|default('multiple') }}">
    {% for q in exam.questions %}
      {% set idx = loop.index0 %}
      <section
        class="question-block rounded-xl border border-border bg-muted/60 p-4"
        data-question-index="{{ idx }}"
      >
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-sm font-semibold text-foreground">
              Q{{ loop.index }}
              <span class="ml-2 text-xs uppercase tracking-wide text-muted-foreground">
                {{ q.type }}
              </span>
            </h2>
            <p class="mt-1 text-sm text-foreground">
              {{ q.question }}
            </p>
          </div>
        </div>

        <input type="hidden" name="q{{ idx }}_num" value="{{ q.number }}" />

        <div class="mt-3 space-y-2">
          {% if q.type in ["single", "true_false"] %}
            {% for opt in q.options %}
              <label class="flex items-center gap-2 text-sm text-foreground cursor-pointer hover:bg-accent/50 p-2 rounded-lg transition-colors">
                <input
                  type="radio"
                  name="q{{ idx }}"
                  value="{{ opt.value }}"
                  class="h-4 w-4 rounded border-border bg-background text-sky-500 focus:ring-sky-500"
                />
                <span>
                  <span class="font-mono text-xs text-muted-foreground">{{ opt.value }})</span>
                  {{ opt.text }}
                </span>
              </label>
            {% endfor %}

          {% elif q.type == "multiple" %}
            <p class="text-xs text-muted-foreground mb-1">Select all that apply.</p>
            {% for opt in q.options %}
              <label class="flex items-center gap-2 text-sm text-foreground cursor-pointer hover:bg-accent/50 p-2 rounded-lg transition-colors">
                <input
                  type="checkbox"
                  name="q{{ idx }}_{{ opt.value }}"
                  class="h-4 w-4 rounded border-border bg-background text-sky-500 focus:ring-sky-500"
                />
                <span>
                  <span class="font-mono text-xs text-muted-foreground">{{ opt.value }})</span>
                  {{ opt.text }}
                </span>
              </label>
            {% endfor %}

          {% elif q.type == "fill_blank" %}
            <input
              type="text"
              name="q{{ idx }}"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 transition-all"
              placeholder="Type your answer..."
            />
          {% endif %}
        </div>
      </section>
    {% endfor %}

    <!-- Controles de navegación para formato 'single' -->
    <div id="singleNav" class="pt-4 flex items-center justify-between gap-3 hidden">
      <button
        type="button"
        id="prevBtn"
        class="inline-flex items-center rounded-lg border border-border bg-muted text-foreground hover:bg-accent px-4 py-2 text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed"
      >
        ← Previous
      </button>

      <div class="flex items-center gap-3">
        <span id="questionCounter" class="text-xs font-mono text-muted-foreground"></span>
        
        <button
          type="button"
          id="nextBtn"
          class="inline-flex items-center rounded-lg bg-sky-500 hover:bg-sky-400 text-foreground font-medium px-4 py-2 text-sm disabled:opacity-40 disabled:cursor-not-allowed"
        >
          Next →
        </button>

        <button
          type="submit"
          id="submitBtn"
          class="inline-flex items-center rounded-lg bg-emerald-500 hover:bg-emerald-400 text-foreground font-medium px-4 py-2 text-sm"
        >
          Submit exam
        </button>
      </div>
    </div>

    <!-- Botón clásico para formato multiple -->
    <div id="multipleSubmitWrapper" class="pt-2">
      <button
        type="submit"
        class="inline-flex items-center rounded-lg bg-sky-500 hover:bg-sky-400 text-foreground font-medium px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-background transition-all"
      >
        Submit exam
      </button>
    </div>
  </form>

  {% if exam.time_limit_seconds %}
  <script>
    (function() {
      const timerEl = document.getElementById('timer');
      const form = document.getElementById('examForm');
      const maxTime = parseInt(timerEl.dataset.maxTime);
      let timeLeft = maxTime;

      function updateDisplay() {
        let display = '';
        const hours = Math.floor(timeLeft / 3600);
        const mins = Math.floor((timeLeft % 3600) / 60);
        const secs = timeLeft % 60;

        if (hours > 0) {
          display += hours + 'h ';
        }
        display += mins.toString().padStart(2, '0') + 'm';
        if (maxTime < 3600 || timeLeft < 3600) {
          display += ' ' + secs.toString().padStart(2, '0') + 's';
        }

        timerEl.textContent = display.trim() || '0s';
        timerEl.className = timeLeft < 60 ?
          'text-3xl font-mono font-bold text-rose-500 mb-6 p-4 bg-muted/50 rounded-xl border border-rose-500/30 text-center animate-pulse' :
          (timeLeft < 300 ?
            'text-3xl font-mono font-bold text-amber-500 mb-6 p-4 bg-muted/50 rounded-xl border border-amber-500/30 text-center animate-pulse' :
            'text-3xl font-mono font-bold text-sky-500 mb-6 p-4 bg-muted/50 rounded-xl border border-sky-500/30 text-center animate-pulse'
          );
      }

      updateDisplay();
      const interval = setInterval(() => {
        timeLeft--;
        updateDisplay();
        if (timeLeft <= 0) {
          clearInterval(interval);
          timerEl.textContent = 'Time is over!';
          timerEl.className = 'text-3xl font-mono font-bold text-rose-500 mb-6 p-4 bg-muted/50 rounded-xl border border-rose-500/30 text-center animate-pulse';
          form.submit();
        }
      }, 1000);
    })();
  </script>
  {% endif %}

  <!-- LÓGICA DE NAVEGACIÓN formato 'single' -->
  <script>
    (function() {
      const form = document.getElementById('examForm');
      const format = form.dataset.format || 'multiple';
      const blocks = Array.from(document.querySelectorAll('.question-block'));
      const singleNav = document.getElementById('singleNav');
      const multipleSubmitWrapper = document.getElementById('multipleSubmitWrapper');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const counterEl = document.getElementById('questionCounter');

      if (format !== 'single') {
        // Modo clásico: no tocamos nada
        return;
      }

      // Modo SINGLE: una pregunta por pantalla
      let currentIndex = 0;

      // Mostrar navegación específica y ocultar submit clásico
      singleNav.classList.remove('hidden');
      multipleSubmitWrapper.classList.add('hidden');

      function updateVisibility() {
        blocks.forEach((el, idx) => {
          if (idx === currentIndex) {
            el.classList.remove('hidden');
          } else {
            el.classList.add('hidden');
          }
        });

        prevBtn.disabled = (currentIndex === 0);
        nextBtn.disabled = (currentIndex === blocks.length - 1);

        if (counterEl) {
          counterEl.textContent = `Question ${currentIndex + 1} / ${blocks.length}`;
        }
      }

      prevBtn.addEventListener('click', function() {
        if (currentIndex > 0) {
          currentIndex--;
          updateVisibility();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      nextBtn.addEventListener('click', function() {
        if (currentIndex < blocks.length - 1) {
          currentIndex++;
          updateVisibility();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      // Confirmación al enviar examen
      form.addEventListener('submit', function(e) {
        const confirmEnd = confirm('Are you sure you want to submit the exam? You will not be able to modify your answers afterwards.');
        if (!confirmEnd) {
          e.preventDefault();
          return false;
        }
      });

      // Inicializar
      updateVisibility();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    })();
  </script>
{% endblock %}
