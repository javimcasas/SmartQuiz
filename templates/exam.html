
{% extends "base.html" %}
{% block title %}{{ exam.title }} ¬∑ SmartQuiz{% endblock %}
{% block content %}
  <!-- Header con back -->
  <div class="mb-6">
    <a href="/" class="text-sm text-muted-foreground hover:text-foreground">&larr; Back to exams</a>
  </div>

  <!-- Info del examen -->
  <div class="mb-8">
    <h1 class="text-2xl font-semibold tracking-tight">{{ exam.title }}</h1>
    <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
      {% if exam.description %}
        <p>{{ exam.description }}</p>
      {% endif %}
      {% if exam.difficulty %}
        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium
                     {% if exam.difficulty == 'easy' %}
                       bg-emerald-500/10 text-emerald-400 border border-emerald-500/30
                     {% elif exam.difficulty == 'hard' %}
                       bg-rose-500/10 text-rose-400 border border-rose-500/30
                     {% else %}
                       bg-amber-500/10 text-amber-400 border border-amber-500/30
                     {% endif %}">
          {{ exam.difficulty|capitalize }}
        </span>
      {% endif %}
      <span class="text-xs uppercase tracking-wide text-muted-foreground">
        {{ exam.questions|length }} questions
      </span>
      {% if exam.time_limit_seconds %}
        {% set hours = (exam.time_limit_seconds // 3600) %}
        {% set mins = ((exam.time_limit_seconds % 3600) // 60) %}
        <span class="text-xs uppercase tracking-wide text-muted-foreground font-mono">
          ‚è±Ô∏è {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
        </span>
      {% endif %}
      <span class="text-xs uppercase tracking-wide text-muted-foreground font-mono">
        Mode: {{ exam.format|default("multiple") }}{% if exam.block_previous %} (No Back){% endif %}
      </span>
    </div>
    {% if exam.time_limit_seconds %}
      <div id="timer" class="text-3xl font-mono font-bold text-sky-500 mt-6 mb-6 p-4 bg-muted/50 rounded-xl border border-sky-500/30 text-center animate-pulse" data-max-time="{{ exam.time_limit_seconds }}"></div>
    {% endif %}
  </div>

  <!-- üî• LAYOUT DIN√ÅMICO seg√∫n modo -->
  <div id="mainLayout" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- üëà √çNDICE LATERAL (solo single mode) -->
    <div id="questionIndex" class="lg:col-span-1 hidden max-h-[60vh] overflow-y-auto">
      <div class="sticky top-0 p-4 bg-background rounded-xl border border-border shadow-sm">
        <h3 class="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          Progress
        </h3>
        <div id="questionList" class="space-y-1"></div>
      </div>
    </div>

    <!-- Contenido principal -->
    <div id="mainContent" class="lg:col-span-3">
      <form method="post" class="space-y-6" id="examForm" data-format="{{ exam.format|default('multiple') }}" data-block-previous="{{ 'true' if exam.block_previous else 'false' }}">
        <!-- üî• class condicional para multiple/single -->
        {% for q in exam.questions %}
          {% set idx = loop.index0 %}
          {% set is_single_mode = exam.format == 'single' %}
          <section
            class="question-block mx-auto lg:mx-0 max-w-4xl rounded-2xl border border-border bg-gradient-to-br from-muted/30 to-background p-6 shadow-sm transition-all duration-300 {% if is_single_mode %}hidden{% else %}block{% endif %}"
            data-question-index="{{ idx }}"
            data-question-number="{{ q.number }}"
          >
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h2 class="text-lg font-bold text-foreground">
                  Q{{ loop.index }} ({{ q.number }})
                  <span class="ml-3 px-2 py-0.5 bg-sky-500/10 text-sky-500 text-xs font-medium rounded-full">
                    {{ q.type|upper }}
                  </span>
                </h2>
                <p class="mt-1 text-foreground/90 leading-relaxed">
                  {{ q.question }}
                </p>
              </div>
              {% if is_single_mode %}
              <div id="q{{ idx }}-status" class="text-xs font-mono text-muted-foreground flex items-center gap-1">
                Not answered
              </div>
              {% endif %}
            </div>
            <input type="hidden" name="q{{ idx }}_num" value="{{ q.number }}" />
            <div class="mt-6 space-y-3">
              {% if q.type in ["single", "true_false"] %}
                {% for opt in q.options %}
                  <label class="flex items-center gap-3 p-3 rounded-xl border border-border hover:border-sky-500/50 hover:bg-sky-500/5 cursor-pointer transition-all duration-200 group">
                    <input
                      type="radio"
                      name="q{{ idx }}"
                      value="{{ opt.value }}"
                      class="h-5 w-5 rounded-full border-2 border-border bg-background text-sky-500 focus:ring-sky-500 focus:ring-2 transition-all duration-200 group-hover:scale-105"
                    />
                    <div>
                      <div class="font-mono text-sm font-medium text-foreground">{{ opt.value }})</div>
                      <div class="text-sm text-foreground/90">{{ opt.text }}</div>
                    </div>
                  </label>
                {% endfor %}
              {% elif q.type == "multiple" %}
                <div class="text-xs font-medium text-muted-foreground mb-3 px-3 py-1.5 bg-muted/50 rounded-lg">
                  Select all that apply
                </div>
                {% for opt in q.options %}
                  <label class="flex items-center gap-3 p-3 rounded-xl border border-border hover:border-sky-500/50 hover:bg-sky-500/5 cursor-pointer transition-all duration-200 group">
                    <input
                      type="checkbox"
                      name="q{{ idx }}_{{ opt.value }}"
                      class="h-5 w-5 rounded border-2 border-border bg-background text-sky-500 focus:ring-sky-500 focus:ring-2 transition-all duration-200 group-hover:scale-105"
                    />
                    <div>
                      <div class="font-mono text-sm font-medium text-foreground">{{ opt.value }})</div>
                      <div class="text-sm text-foreground/90">{{ opt.text }}</div>
                    </div>
                  </label>
                {% endfor %}
              {% elif q.type == "fill_blank" %}
                <div class="relative">
                  <input
                    type="text"
                    name="q{{ idx }}"
                    class="w-full rounded-xl border-2 border-border bg-background px-4 py-3 text-lg font-medium text-foreground placeholder:text-muted-foreground focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/50 shadow-sm transition-all duration-300"
                    placeholder="Type your answer here..."
                    autocomplete="off"
                  />
                  <div class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-20">
                    <span class="text-2xl">______</span>
                  </div>
                </div>
              {% endif %}
            </div>
          </section>
        {% endfor %}

        <!-- Navegaci√≥n single mode -->
        <div id="singleNav" class="pt-8 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-4 hidden">
          <button
            type="button"
            id="prevBtn"
            class="flex-1 sm:flex-none order-2 sm:order-1 inline-flex items-center justify-center gap-2 rounded-xl border-2 border-border bg-muted text-foreground hover:bg-accent hover:border-accent px-6 py-3 text-sm font-semibold transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed disabled:border-muted"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Previous
          </button>
          <div class="flex items-center gap-3 order-1 sm:order-2">
            <span id="questionCounter" class="text-sm font-mono text-muted-foreground bg-muted/50 px-4 py-2 rounded-xl font-semibold min-w-[120px] text-center"></span>
            <button
              type="button"
              id="nextBtn"
              class="inline-flex items-center justify-center gap-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white font-semibold px-8 py-3 text-sm shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed disabled:bg-sky-500"
            >
              Next
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
            <button
              type="submit"
              id="submitBtn"
              class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold px-8 py-3 text-sm shadow-xl hover:shadow-2xl transition-all duration-300 hidden"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              Submit Exam
            </button>
          </div>
        </div>

        <!-- Submit multiple mode -->
        <div id="multipleSubmitWrapper" class="pt-8">
          <button
            type="submit"
            class="mx-auto lg:mx-0 w-full lg:w-auto max-w-md inline-flex items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-semibold px-10 py-4 text-lg shadow-2xl hover:shadow-3xl hover:-translate-y-1 transition-all duration-500 focus:outline-none focus:ring-4 focus:ring-sky-500/50"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Submit Exam
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if exam.time_limit_seconds %}
  <script>
    // Timer logic
    (function() {
      const timerEl = document.getElementById('timer');
      if (!timerEl) return;

      const form = document.getElementById('examForm');
      const maxTime = parseInt(timerEl.dataset.maxTime);
      let timeLeft = maxTime;

      function updateDisplay() {
        const hours = Math.floor(timeLeft / 3600);
        const mins = Math.floor((timeLeft % 3600) / 60);
        const secs = timeLeft % 60;
        const display = `${hours ? hours + 'h ' : ''}${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        timerEl.textContent = display;
        const isDanger = timeLeft < 60;
        const isWarning = timeLeft < 300;
        timerEl.className = isDanger ?
          'text-3xl font-mono font-bold text-rose-500 mt-6 mb-6 p-6 bg-rose-50/50 rounded-2xl border-2 border-rose-500 shadow-2xl text-center animate-pulse' :
          (isWarning ?
            'text-3xl font-mono font-bold text-amber-500 mt-6 mb-6 p-6 bg-amber-50/50 rounded-2xl border-2 border-amber-500 shadow-xl text-center animate-pulse' :
            'text-3xl font-mono font-bold text-sky-500 mt-6 mb-6 p-6 bg-sky-50/50 rounded-2xl border-2 border-sky-500 shadow-lg text-center animate-pulse'
          );
      }
      updateDisplay();
      const interval = setInterval(() => {
        timeLeft--;
        updateDisplay();
        if (timeLeft <= 0) {
          clearInterval(interval);
          timerEl.innerHTML = '<div class="animate-bounce text-4xl mb-2">‚è∞</div>Time Over!';
          setTimeout(() => form.submit(), 1500);
        }
      }, 1000);
    })();
  </script>
  {% endif %}

  <!-- üéØ SINGLE MODE (FIX: LIMPIAR sessionStorage) -->
  <script>
  (function() {
    const form = document.getElementById('examForm');
    const format = form.dataset.format || 'multiple';

    if (format !== 'single') return;

    // üî• FIX 1: LIMPIAR sessionStorage al cargar (reset progreso)
    const savedKey = `exam_${window.location.pathname}`;
    sessionStorage.removeItem(savedKey);
    let currentIndex = 0; // ‚úÖ SIEMPRE empezar en 0

    // Layout
    const mainLayout = document.getElementById('mainLayout');
    const questionIndex = document.getElementById('questionIndex');
    mainLayout.classList.add('lg:grid-cols-4');
    questionIndex.classList.remove('hidden');

    const blockPrevious = form.dataset.blockPrevious === 'true';
    const blocks = Array.from(document.querySelectorAll('.question-block'));
    const singleNav = document.getElementById('singleNav');
    const multipleSubmitWrapper = document.getElementById('multipleSubmitWrapper');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const counterEl = document.getElementById('questionCounter');
    const questionList = document.getElementById('questionList');

    const questionStates = new Array(blocks.length).fill(false);

    singleNav.classList.remove('hidden');
    multipleSubmitWrapper.style.display = 'none';

    function updateQuestionState(idx) {
      const block = blocks[idx];
      const inputs = block.querySelectorAll('input[type="radio"], input[type="checkbox"], input[type="text"]');
      const hasAnswer = Array.from(inputs).some(input =>
        input.type === 'radio' ? input.checked :
        input.type === 'checkbox' ? input.checked :
        input.value.trim()
      );
      questionStates[idx] = hasAnswer;
      const statusEl = block.querySelector(`#q${idx}-status`);
      if (statusEl) {
        statusEl.innerHTML = hasAnswer ?
          '<span class="text-emerald-500 flex items-center gap-1">‚úÖ Answered</span>' :
          '<span class="text-muted-foreground flex items-center gap-1">‚ö™ Not answered</span>';
      }
    }

    function createQuestionIndex() {
      blocks.forEach((block, idx) => {
        const btn = document.createElement('button');
        btn.className = `
          w-full flex items-center gap-2 p-2.5 rounded-lg text-left text-sm font-medium transition-all duration-200 
          hover:bg-accent focus:outline-none focus:ring-2 focus:ring-sky-500/50
          ${blockPrevious && idx < currentIndex ? 'opacity-50 cursor-not-allowed bg-muted pointer-events-none' : ''}
        `;
        btn.dataset.index = idx;
        btn.innerHTML = `
          <span class="w-6 h-6 flex items-center justify-center rounded font-mono text-xs font-bold bg-muted/50">${idx + 1}</span>
          <span>Q${idx + 1}</span>
        `;

        if (!blockPrevious || idx >= currentIndex) {
          btn.addEventListener('click', () => goToQuestion(idx));
        }

        questionList.appendChild(btn);
      });
      updateIndexVisual();
    }

    function updateIndexVisual() {
      Array.from(questionList.children).forEach((btn, idx) => {
        const numEl = btn.querySelector('span:first-child');
        const isCurrent = idx === currentIndex;
        const isAnswered = questionStates[idx];

        if (isCurrent) {
          btn.classList.add('bg-sky-500/10', 'border', 'border-sky-500/50', 'ring-2', 'ring-sky-500/30');
          numEl.className = 'w-6 h-6 flex items-center justify-center rounded font-mono text-xs font-bold bg-sky-500 text-white shadow-md';
          numEl.textContent = '‚óè';
        } else if (isAnswered && idx <= currentIndex) {
          btn.classList.add('bg-emerald-500/10', 'border', 'border-emerald-500/30');
          numEl.className = 'w-6 h-6 flex items-center justify-center rounded font-mono text-xs font-bold bg-emerald-500 text-white shadow-sm';
          numEl.textContent = '‚úì';
        } else {
          btn.classList.remove('bg-sky-500/10', 'border', 'bg-emerald-500/10', 'ring-2');
          numEl.className = 'w-6 h-6 flex items-center justify-center rounded font-mono text-xs font-bold bg-muted/50';
          numEl.textContent = idx + 1;
        }

        if (blockPrevious && idx < currentIndex) {
          btn.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        }
      });
    }

    function goToQuestion(idx) {
      if (blockPrevious && idx < currentIndex) return;
      currentIndex = idx;
      updateVisibility();
    }

    function updateVisibility() {
      blocks.forEach((el, idx) => {
        el.style.display = idx === currentIndex ? 'block' : 'none';
      });

      prevBtn.disabled = blockPrevious || currentIndex === 0;
      nextBtn.disabled = currentIndex === blocks.length - 1;
      submitBtn.style.display = currentIndex === blocks.length - 1 ? 'inline-flex' : 'none';

      counterEl.textContent = `Q${currentIndex + 1} / ${blocks.length}`;
      counterEl.className = 'text-sm font-mono bg-sky-500/10 text-sky-500 px-4 py-2 rounded-xl font-bold min-w-[120px] text-center shadow-md';

      updateIndexVisual();
      updateQuestionState(currentIndex);
      blocks[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Listeners inputs
    blocks.forEach((block, idx) => {
      const inputs = block.querySelectorAll('input');
      inputs.forEach(input => {
        input.addEventListener('change', () => updateQuestionState(idx));
        if (input.type === 'text') {
          input.addEventListener('input', () => updateQuestionState(idx));
        }
      });
    });

    // Navegaci√≥n
    prevBtn.addEventListener('click', () => {
      if (!prevBtn.disabled && currentIndex > 0) {
        currentIndex--;
        updateVisibility();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (!nextBtn.disabled && currentIndex < blocks.length - 1) {
        currentIndex++;
        updateVisibility();
      }
    });

    // Submit confirm
    form.addEventListener('submit', (e) => {
      const unanswered = questionStates.filter(s => !s).length;
      let msg = `¬øSubmit the exam? `;
      if (unanswered > 0) msg += `${unanswered} question${unanswered > 1 ? 's' : ''} unanswered. `;
      msg += 'You cannot modify answers afterwards.';
      if (!confirm(msg)) e.preventDefault();
    });

    // üî• INIT (SIN sessionStorage)
    createQuestionIndex();
    blocks.forEach((_, idx) => updateQuestionState(idx));
    updateVisibility();

    // Guardar solo DENTRO de la sesi√≥n (NO al recargar)
    window.addEventListener('beforeunload', () => {
      sessionStorage.setItem(savedKey, JSON.stringify({ currentIndex, states: questionStates }));
    });
  })();
  </script>

  <!-- Multiple mode layout + confirm -->
  <script>
  (function() {
    const form = document.getElementById('examForm');
    const format = form.dataset.format || 'multiple';

    if (format === 'multiple') {
      const mainLayout = document.getElementById('mainLayout');
      const mainContent = document.getElementById('mainContent');
      const questionIndex = document.getElementById('questionIndex');

      mainLayout.className = 'grid grid-cols-1 gap-6';
      mainContent.className = '';
      questionIndex.style.display = 'none';

      const questionBlocks = document.querySelectorAll('.question-block');
      questionBlocks.forEach(block => {
        block.classList.add('max-w-4xl', 'mx-auto');
      });
    }

    if (format !== 'multiple') return;

    form.addEventListener('submit', (e) => {
      const blocks = document.querySelectorAll('.question-block');
      let answeredCount = 0;
      let totalQuestions = blocks.length;

      blocks.forEach(block => {
        const inputs = block.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked, input[type="text"]');
        const hasAnswer = Array.from(inputs).some(input => 
          input.type === 'text' ? input.value.trim() : input.checked
        );
        if (hasAnswer) answeredCount++;
      });

      const unanswered = totalQuestions - answeredCount;
      let msg = `¬øSubmit the exam? `;
      if (unanswered > 0) {
        msg += `${unanswered} question${unanswered > 1 ? 's' : ''} unanswered. `;
      }
      msg += 'You cannot modify answers afterwards.';

      if (!confirm(msg)) {
        e.preventDefault();
        return false;
      }
    });
  })();
  </script>
{% endblock %}
